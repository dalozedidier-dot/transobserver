name: test-data-matrix

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  matrix-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Liste "utilisable" pour CI (petits CSV, noms propres)
        file:
          - test_data/minimal_timeseries.csv
          - test_data/GDPDeflator.csv
          - test_data/CPI.csv
          - test_data/Population.csv
          - test_data/RealGDP.csv
          - test_data/RealPerCapitaGDP.csv
          - test_data/RealExchangeRate.csv
          - test_data/ITU_DH_INT_USER_PT.csv
          - test_data/ITU_DH_ACT_MOB_PER_100.csv
          - test_data/WB_WBL_SG_LAW_INDX.csv
        mode: [mock]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Smoke one file
        id: run
        shell: bash
        run: |
          set -euo pipefail

          chmod +x tools/run_parallel.sh || true
          chmod +x tools/run_parallel_real.sh || true
          chmod +x tools/smoke_one.py || true

          # IMPORTANT: smoke_one.py prints logs; we only keep LAST LINE as cycle_id
          CYCLE_ID="$(python3 tools/smoke_one.py \
            --file "${{ matrix.file }}" \
            --mode "${{ matrix.mode }}" | tail -n 1 | tr -d '\r')"

          echo "CYCLE_ID=$CYCLE_ID" >> "$GITHUB_ENV"

          # safer output (supports any content)
          {
            echo "cycle_id<<EOF"
            echo "$CYCLE_ID"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "### RÃ©sultat" >> "$GITHUB_STEP_SUMMARY"
          echo "- file: \`${{ matrix.file }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- mode: \`${{ matrix.mode }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- cycle_id: \`$CYCLE_ID\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Show unified manifest
        shell: bash
        run: |
